From 268e8fab97f8c44ee4f98bf3274f2c96947bd4db Mon Sep 17 00:00:00 2001
From: Mark Nauwelaerts <mark.nauwelaerts@collabora.co.uk>
Date: Fri, 7 Aug 2009 13:07:17 +0200
Subject: [PATCH] baseparse: prevent infinite loop when draining

---
 gst/aacparse/gstbaseparse.c  |    8 ++++++++
 gst/amrparse/gstbaseparse.c  |    8 ++++++++
 gst/flacparse/gstbaseparse.c |    8 ++++++++
 3 files changed, 24 insertions(+), 0 deletions(-)

diff --git a/gst/aacparse/gstbaseparse.c b/gst/aacparse/gstbaseparse.c
index cc865e6..5b18e2f 100644
--- a/gst/aacparse/gstbaseparse.c
+++ b/gst/aacparse/gstbaseparse.c
@@ -844,6 +844,8 @@ gst_base_parse_drain (GstBaseParse * parse)
 {
   guint avail;
 
+  GST_DEBUG_OBJECT (parse, "draining");
+
   for (;;) {
     avail = gst_adapter_available (parse->adapter);
     if (!avail)
@@ -853,6 +855,12 @@ gst_base_parse_drain (GstBaseParse * parse)
     if (gst_base_parse_chain (parse->sinkpad, NULL) != GST_FLOW_OK) {
       break;
     }
+
+    /* nothing changed, maybe due to truncated frame; break infinite loop */
+    if (avail == gst_adapter_available (parse->adapter)) {
+      GST_DEBUG_OBJECT (parse, "no change during draining; flushing");
+      gst_adapter_clear (parse->adapter);
+    }
   }
 }
 
diff --git a/gst/amrparse/gstbaseparse.c b/gst/amrparse/gstbaseparse.c
index 0065043..e638f93 100644
--- a/gst/amrparse/gstbaseparse.c
+++ b/gst/amrparse/gstbaseparse.c
@@ -844,6 +844,8 @@ gst_base_parse_drain (GstBaseParse * parse)
 {
   guint avail;
 
+  GST_DEBUG_OBJECT (parse, "draining");
+
   for (;;) {
     avail = gst_adapter_available (parse->adapter);
     if (!avail)
@@ -853,6 +855,12 @@ gst_base_parse_drain (GstBaseParse * parse)
     if (gst_base_parse_chain (parse->sinkpad, NULL) != GST_FLOW_OK) {
       break;
     }
+
+    /* nothing changed, maybe due to truncated frame; break infinite loop */
+    if (avail == gst_adapter_available (parse->adapter)) {
+      GST_DEBUG_OBJECT (parse, "no change during draining; flushing");
+      gst_adapter_clear (parse->adapter);
+    }
   }
 }
 
diff --git a/gst/flacparse/gstbaseparse.c b/gst/flacparse/gstbaseparse.c
index 5d89dc5..1fced70 100644
--- a/gst/flacparse/gstbaseparse.c
+++ b/gst/flacparse/gstbaseparse.c
@@ -897,6 +897,8 @@ gst_base_parse_drain (GstBaseParse * parse)
 {
   guint avail;
 
+  GST_DEBUG_OBJECT (parse, "draining");
+
   for (;;) {
     avail = gst_adapter_available (parse->priv->adapter);
     if (!avail)
@@ -906,6 +908,12 @@ gst_base_parse_drain (GstBaseParse * parse)
     if (gst_base_parse_chain (parse->sinkpad, NULL) != GST_FLOW_OK) {
       break;
     }
+
+    /* nothing changed, maybe due to truncated frame; break infinite loop */
+    if (avail == gst_adapter_available (parse->adapter)) {
+      GST_DEBUG_OBJECT (parse, "no change during draining; flushing");
+      gst_adapter_clear (parse->adapter);
+    }
   }
 }
 
